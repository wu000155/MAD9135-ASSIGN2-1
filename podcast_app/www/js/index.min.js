var checkOnlineInterval=null;var podcastArray=[];var tap=document.createEvent("Event");tap.initEvent("tap",true,true);var app={initialize:function(){this.bindEvents();},bindEvents:function(){document.addEventListener('deviceready',this.onDeviceReady,false);},onDeviceReady:function(){if(app.detectTouchSupport()){console.log();$('.back,.addnewBtn,.setDone').bind('touchend',app.handleTouchEnd);$('.back').bind('tap',play.goBack);$(".addnewBtn").bind("tap",app.showAddnew);$(".setDone").bind("tap",app.addnewPodcast);}else{$('.back').bind('click',play.goBack);$(".addnewBtn").bind("click",app.showAddnew);$(".setDone").bind("click",app.addnewPodcast);}app.checkdevice();app.checkOnline();},checkdevice:function(){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,app.onFileSystemSuccess,app.onFileSystemfail);},onFileSystemSuccess:function(fileSystem){console.log('onFileSystemSuccess');console.log("FileSystem success : "+fileSystem.name);console.log(isComplete);if(isComplete==true){var deletedFileName=$('.info h2').text();console.log(deletedFileName);fileSystem.root.getFile(deletedFileName+".mp3",{create:false,exclusive:false},function(fileEntry){function success(entry){console.log("Removal succeeded");}function fail(error){alert('Error removing file: '+error.code);}fileEntry.remove(success,fail);},app.failFile);setTimeout(function(){var directoryReader=fileSystem.root.createReader();directoryReader.readEntries(app.readerSuccess,app.directoryReaderFail);},30)}else{var directoryReader=fileSystem.root.createReader();directoryReader.readEntries(app.readerSuccess,app.directoryReaderFail);}fileSystem.root.getFile("podcasts.txt",{create:true,exclusive:false},function(fileEntry){fileEntry.file(function(file){var reader=new FileReader();reader.onloadend=function(evt){console.log("readAsText");if(evt.target.result.length>0){var jsonfile=JSON.parse(evt.target.result)if(jsonfile.length>0){podcastArray=jsonfile;console.log(JSON.parse(podcastArray[0]));}console.log(evt.target.result);}};reader.readAsText(file);},app.failreading);},app.failFile);},readerSuccess:function(entries){console.log('readerSuccess');var mp3File=[];for(var i=0;i<entries.length;i++){var fileName=entries[i].name
if(fileName.indexOf(".mp3")==fileName.length-4){console.log(fileName);mp3File.push(fileName.split('.')[0]);}}if(mp3File.length>0){console.log(mp3File.length);console.log(mp3File);console.log($('.podcastMp3').length);if($('.podcastMp3').length>0){$('.podcastMp3').remove();}if($('.newGuynotes')){$('.newGuynotes').remove();}if($('.logo')){$(".logo").remove();}for(var i=0;i<mp3File.length;i++){$('.podcastList').append("<li class='podcastMp3'>"+mp3File[i]+"</li>");}if(app.detectTouchSupport()){$('.podcastMp3').bind('touchend',app.handleTouchEnd);$('.podcastMp3').bind('tap',play.showPodcastPage);}else{$('.podcastMp3').bind('click',play.showPodcastPage)}}},checkOnline:function(){console.log('checkOnline');var networkState=navigator.connection.type;var states={};states[Connection.UNKNOWN]='Unknown connection';states[Connection.ETHERNET]='Ethernet connection';states[Connection.WIFI]='WiFi connection';states[Connection.CELL_2G]='Cell 2G connection';states[Connection.CELL_3G]='Cell 3G connection';states[Connection.CELL_4G]='Cell 4G connection';states[Connection.CELL]='Cell generic connection';states[Connection.NONE]='No network connection';if(states[networkState]!='No network connection'){if(checkOnlineInterval!=null){clearInterval(checkOnlineInterval);checkOnlineInterval=null;}console.log(states[networkState]);document.addEventListener("online",app.getPodcastXml,false);}else{document.addEventListener("offline",app.networkfail,false);alert(states[networkState]);}},getPodcastXml:function(){console.log('getPodcastXml');var podcastURL=localStorage.getItem("podcastURL");console.log(podcastURL);if(podcastURL!=null){if($('.newGuynotes')){$('.newGuynotes').remove();}var request=new XMLHttpRequest();request.open('GET',podcastURL,true);request.onreadystatechange=function(){if(request.readyState===4||request.readyState=="complete"){if(request.status===200||request.status===0){var podcastXml=request.responseXML;setTimeout(function(){app.downloadNewPodcasts(podcastXml)},300);console.log(podcastXml);}else{$('#frontPage').append('<div class="notification">Oops! fail to fetch your podcast, please try again</div>');setTimeout(function(){$('#frontPage .notification').remove()},4000)}}}request.send(null);}},downloadNewPodcasts:function(podcastXml){console.log('downloadNewPodcasts');console.log(podcastArray.length)var isRecord;if(podcastArray.length>0){for(var i=0;i<podcastArray.length;i++){if(JSON.parse(podcastArray[i]).channel==$(podcastXml).find('channel>title').text()){isRecord=true;break;}}}console.log(isRecord);if(isRecord){var localNewestDate=0;var localChannleItemsDate=[];for(var i=0;i<podcastArray.length;i++){console.log(JSON.parse(podcastArray[i]).channel);if(JSON.parse(podcastArray[i]).channel==$(podcastXml).find('channel>title').text()){localChannleItemsDate.push(JSON.parse(podcastArray[i]).date);}}for(var i=0;i<localChannleItemsDate.length;i++){var crruentDate=new Date(localChannleItemsDate[i])if(crruentDate.getTime()>localNewestDate){localNewestDate=crruentDate.getTime();}}console.log(localNewestDate);for(var index=0;index<$(podcastXml).find('item').length;index++){var newDate=$(podcastXml).find("item>pubDate").eq(index).text().split('+');if(new Date(newDate[0]).getTime()>localNewestDate){console.log('get news')var newTitleWhole=$(podcastXml).find('item>title').eq(index).text();var newFileTransfer=new FileTransfer();var newUri=encodeURI($(podcastXml).find('item>enclosure').eq(index).attr('url'));var newSpecialChars="#:\./|-#:\./|-#:\./|-#:\./|-#:\./|-#:\./|-#:\./|-#:\./|-#:\./|-#:\./|-"for(var s=0;s<newSpecialChars.length;s++){console.log(newSpecialChars[s]);if(newTitleWhole.indexOf(newSpecialChars[s])>-1){newTitleWhole=newTitleWhole.replace(newSpecialChars[s],' ')}console.log('titleWhole:'+newTitleWhole);}var newFileURL=cordova.file.externalRootDirectory+newTitleWhole+'.mp3';console.log($(podcastXml).find('item>title').eq(index).text());var newPodcastInfo='{'newPodcastInfo+='"channel":"'+$(podcastXml).find('channel>title').text()+'",'newPodcastInfo+='"title":"'+newTitleWhole+'",'newPodcastInfo+='"img":"'+$(podcastXml).find('item>image').eq(index).attr('href')+'",'newPodcastInfo+='"duration":"'+$(podcastXml).find("item>duration").eq(index).text()+'",'newPodcastInfo+='"date":"'+newDate[0]+'"'newPodcastInfo+='}'podcastArray.push(newPodcastInfo);console.log(podcastArray);if($('#frontPage .notification')){$('#frontPage .notification').remove();}$('#frontPage').append('<div class="notificationDownLoading">found new podcast for you, downloading...</div>');setTimeout(function(){$('#frontPage .notificationDownLoading').remove()},4000);newFileTransfer.download(newUri,newFileURL,app.downloadSuccessCallback,app.downloadErrorCallback,false);}}}else{for(var i=0;i<2;i++){var titleWhole=$(podcastXml).find('item>title').eq(i).text();var fileTransfer=new FileTransfer();var uri=encodeURI($(podcastXml).find('item>enclosure').eq(i).attr('url'));var specialChars="#:\./|-#:\./|-#:\./|-#:\./|-#:\./|-#:\./|-#:\./|-#:\./|-#:\./|-#:\./|-"for(var s=0;s<specialChars.length;s++){console.log(specialChars[s]);if(titleWhole.indexOf(specialChars[s])>-1){titleWhole=titleWhole.replace(specialChars[s],' ')console.log('titleWhole:'+titleWhole);}}var fileURL=cordova.file.externalRootDirectory+titleWhole+'.mp3';var date=$(podcastXml).find("item>pubDate").eq(i).text().split('+');var podcastInfo='{'podcastInfo+='"channel":"'+$(podcastXml).find('channel>title').text()+'",'podcastInfo+='"title":"'+titleWhole+'",'podcastInfo+='"img":"'+$(podcastXml).find('item>image').eq(i).attr('href')+'",'podcastInfo+='"duration":"'+$(podcastXml).find("item>duration").eq(i).text()+'",'podcastInfo+='"date":"'+date[0]+'"'podcastInfo+='}'podcastArray.push(podcastInfo);console.log(podcastArray);fileTransfer.download(uri,fileURL,app.downloadSuccessCallback,app.downloadErrorCallback,false);}$('#frontPage').append('<div class="notificationDownLoading">try to download podcast for you, you can do some thing else</div>');setTimeout(function(){$('#frontPage .notificationDownLoading').remove()},4000)}},downloadSuccessCallback:function(entry){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,app.gotFile,app.failFile);},gotFile:function(fileSystem){fileSystem.root.getFile("podcasts.txt",{create:true,exclusive:false},app.gotFileEntry,app.failFile);},gotFileEntry:function(fileEntry){console.log('gotFileEntry')fileEntry.createWriter(app.gotFileWriter,app.failFile);},gotFileWriter:function(writer){console.log(podcastArray);var podcastJson=JSON.stringify(podcastArray)writer.write(podcastJson);app.checkdevice();},showAddnew:function(){var availableTags=["http://feeds.feedburner.com/ThrillingAdventureHour","http://feeds.feedburner.com/WelcomeToNightVale"];$("#urlInput").autocomplete({source:availableTags});if($('.menu').css('display')=='block'){console.log($('.menu').css('display'));$('.inner').removeClass('addnewBtnActive');$('.addnewBtn').removeClass('addnewBtnActive');$('.menu').css('left','-30%');setTimeout(function(){$('.menu').addClass('hide')},200);}else{console.log($('.menu').css('display'));$('.inner').addClass('addnewBtnActive');$('.addnewBtn').addClass('addnewBtnActive');$('.menu').removeClass('hide');setTimeout(function(){$('.menu').css('left','0');},10)}},addnewPodcast:function(ev){console.log($('input').val().indexOf("http://"));if(($('input').val().indexOf("http://")>-1)&&($('input').val()!='')){localStorage.setItem("podcastURL",$('input').val());$('.inner').removeClass('addnewBtnActive');$('.addnewBtn').removeClass('addnewBtnActive');$('.menu').css('left','-30%');setTimeout(function(){$('.menu').addClass('hide')},200);var networkState=navigator.connection.type;var states={};states[Connection.UNKNOWN]='Unknown connection';states[Connection.ETHERNET]='Ethernet connection';states[Connection.WIFI]='WiFi connection';states[Connection.CELL_2G]='Cell 2G connection';states[Connection.CELL_3G]='Cell 3G connection';states[Connection.CELL_4G]='Cell 4G connection';states[Connection.CELL]='Cell generic connection';states[Connection.NONE]='No network connection';if(states[networkState]!='No network connection'){$(".logo").remove();app.getPodcastXml();}else{app.networkfail();}}else{$('.menu').append('<div class="notification">Invalid URL</div>');setTimeout(function(){$('.menu .notification').remove()},4000)}},onFileSystemfail:function(evt){console.log(evt.target.error.code);},onGetDirectoryFail:function(){console.log("error getting dir")},directoryReaderFail:function(){console.log("directoryReaderFail")},networkfail:function(){console.log('networkfail')checkOnlineInterval=setInterval(app.checkOnline,10000);},downloadErrorCallback:function(error){console.log("download error source "+error.source);console.log("download error target "+error.target);},failFile:function(error){console.log(error.code);},failreading:function(){console.log('failreading');},handleTouchEnd:function(ev){ev.preventDefault();var target=ev.currentTarget;target.dispatchEvent(tap);},detectTouchSupport:function(){msGesture=navigator&&navigator.msPointerEnabled&&navigator.msMaxTouchPoints>0&&MSGesture;touchSupport=(("ontouchstart"in window)||msGesture||(window.DocumentTouch&&document instanceof DocumentTouch));return touchSupport;}};